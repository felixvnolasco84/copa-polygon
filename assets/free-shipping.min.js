/**
 *  @class
 *  @function FreeShipping
 */

if (!customElements.get('free-shipping')) {
    class FreeShipping extends HTMLElement {
      constructor() {
        super();
      }
      connectedCallback() {
  
        let amount_text = this.querySelector('.free-shipping--text span');
        let total = parseInt(this.dataset.cartTotal, 10);
        let minimum = Math.round(parseInt(this.dataset.minimum, 10) * (Shopify.currency.rate || 1));
        let percentage = 1;
        this.remainingText = this.querySelector('.free-shipping--text-remaining');
        this.fullText = this.querySelector('.free-shipping--text-full');
        if (total < minimum) {
          percentage = total / minimum;
  
          if (amount_text) {
            let remaining = minimum - total,
              format = window.theme.settings.money_with_currency_format || "${{amount}}";
            amount_text.innerHTML = formatMoney(remaining, format);
          }
          this.remainingText.style.display = 'block';
          this.fullText.style.display = 'none';
        } else {
          this.remainingText.style.display = 'none';
          this.fullText.style.display = 'block';
        }
  
        this.style.setProperty('--percentage', percentage);
  
      }
    }
    customElements.define('free-shipping', FreeShipping);
  }


  function formatMoney(cents, format) {
  if (typeof cents === 'string') {
    cents = cents.replace('.', '');
  }
  let value = '';
  const placeholderRegex = /\{\{\s*(\w+)\s*\}\}/;
  const formatString = format || moneyFormat;

  function formatWithDelimiters(
    number,
    precision = 2,
    thousands = ',',
    decimal = '.'
  ) {
    if (isNaN(number) || number == null) {
      return 0;
    }

    number = (number / 100.0).toFixed(precision);

    const parts = number.split('.');
    const dollarsAmount = parts[0].replace(
      /(\d)(?=(\d\d\d)+(?!\d))/g,
      `$1${thousands}`
    );
    const centsAmount = parts[1] ? decimal + parts[1] : '';

    return dollarsAmount + centsAmount;
  }

  switch (formatString.match(placeholderRegex)[1]) {
    case 'amount':
      value = formatWithDelimiters(cents, 2);
      break;
    case 'amount_no_decimals':
      value = formatWithDelimiters(cents, 0);
      break;
    case 'amount_with_comma_separator':
      value = formatWithDelimiters(cents, 2, '.', ',');
      break;
    case 'amount_no_decimals_with_comma_separator':
      value = formatWithDelimiters(cents, 0, '.', ',');
      break;
		case "amount_with_apostrophe_separator":
      value = formatWithDelimiters(cents, 2, "'", ".");
      break;
  }

  return formatString.replace(placeholderRegex, value);
}
